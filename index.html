<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨é–€å‹•æ…‹ç®¡ç†ç³»çµ± V16 (è‰²å½©å€éš”ç‰ˆ)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js"
        }
    }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&display=swap');

        body { font-family: 'Noto Sans TC', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .avatar-circle {
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 selection:bg-indigo-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            User, Briefcase, Calendar, Plane, Home, Clock, Plus, X, 
            ChevronLeft, ChevronRight, LayoutGrid, List, CalendarDays, Edit3, Settings, Trash2, Save, CalendarRange, AlertCircle, Cloud, RefreshCw, CalendarCheck, Coffee, Info, Utensils, Globe, PartyPopper, GraduationCap, Megaphone, Cake, HelpCircle
        } from 'lucide-react';
        
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch } from "firebase/firestore";

        // ==========================================
        // ğŸ”¥ è¨­å®šå€ (æ‚¨çš„ Firebase è¨­å®š) ğŸ”¥
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyCSfljgqFZHv7iP-CwXZl0cuYX350yyXao",
          authDomain: "teamschedule-7feee.firebaseapp.com",
          projectId: "teamschedule-7feee",
          storageBucket: "teamschedule-7feee.firebasestorage.app",
          messagingSenderId: "608682561982",
          appId: "1:608682561982:web:56aebc3b128633c10e69ef",
          measurementId: "G-CBTDEWTRW1"
        };

        // åˆå§‹åŒ– Firebase
        let db;
        try {
            if (firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("è«‹å¡«å…¥")) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
            }
        } catch (e) { console.error("Firebase init error:", e); }

        // --- å¸¸æ•¸è¨­å®š ---
        const WORK_START_HOUR = 8;
        const WORK_END_HOUR = 17; 

        const TIME_OPTIONS = [];
        for (let h = WORK_START_HOUR; h <= 18; h++) {
            const hourStr = h < 10 ? `0${h}` : `${h}`;
            TIME_OPTIONS.push(`${hourStr}:00`);
            if (h < 18) TIME_OPTIONS.push(`${hourStr}:30`);
        }

        // ğŸ”¥ 1. äººå“¡ç‹€æ…‹é¡è‰² (ä¿æŒåŸæ¨£æˆ–å¾®èª¿) ğŸ”¥
        const STATUS_TYPES = {
            office: { id: 'office', label: 'å‡ºå‹¤', color: 'bg-white text-emerald-600 border-emerald-200 ring-1 ring-emerald-100', circle: 'bg-emerald-50 text-emerald-600 border border-emerald-200', icon: User },
            meeting: { id: 'meeting', label: 'æœƒè­°', color: 'bg-blue-50 text-blue-700 border-blue-200', circle: 'bg-blue-500 text-white', icon: Briefcase },
            trip: { id: 'trip', label: 'å‡ºå·®', color: 'bg-purple-50 text-purple-700 border-purple-200', circle: 'bg-purple-500 text-white', icon: Plane },
            leave: { id: 'leave', label: 'ä¼‘å‡', color: 'bg-rose-50 text-rose-700 border-rose-200', circle: 'bg-rose-500 text-white', icon: Home },
            break: { id: 'break', label: 'ä¸‹ç­/ä¼‘å‡', color: 'bg-slate-50 text-slate-400 border-slate-200', circle: 'bg-slate-200 text-slate-400', icon: Clock },
        };

        const SPECIAL_TYPES = ['meeting', 'trip', 'leave'];

        // ğŸ”¥ 2. æ´»å‹•é¡å‹é¡è‰² (å¤§å¹…èª¿æ•´ä»¥å€éš”) ğŸ”¥
        // Client: Teal (å€éš” Meeting çš„ Blue)
        // Training: Cyan (å€éš” Trip çš„ Purple)
        // Party: Amber (å€éš” Leave çš„ Rose)
        const EVENT_TYPES = {
            client: { id: 'client', label: 'å®¢æˆ¶ä¾†è¨ª', char: 'å®¢', icon: Globe, color: 'text-teal-700 bg-teal-50 border-teal-200', badge: 'bg-teal-100 text-teal-800 border border-teal-200' },
            dinner: { id: 'dinner', label: 'éƒ¨é–€èšé¤', char: 'èš', icon: Utensils, color: 'text-orange-700 bg-orange-50 border-orange-200', badge: 'bg-orange-100 text-orange-800 border border-orange-200' },
            party: { id: 'party', label: 'æ…¶ç”Ÿ/æ´»å‹•', char: 'æ…¶', icon: PartyPopper, color: 'text-amber-700 bg-amber-50 border-amber-200', badge: 'bg-amber-100 text-amber-800 border border-amber-200' },
            training: { id: 'training', label: 'æ•™è‚²è¨“ç·´', char: 'è¨“', icon: GraduationCap, color: 'text-cyan-700 bg-cyan-50 border-cyan-200', badge: 'bg-cyan-100 text-cyan-800 border border-cyan-200' },
            announce: { id: 'announce', label: 'é‡è¦å…¬å‘Š', char: 'å…¬', icon: Megaphone, color: 'text-slate-600 bg-slate-50 border-slate-200', badge: 'bg-slate-200 text-slate-700 border border-slate-300' },
        };

        // 2025-2026 å°ç£åœ‹å®šå‡æ—¥è¡¨
        const TAIWAN_HOLIDAYS = {
            '2025-01-01': 'å…ƒæ—¦', '2025-01-25': 'æ˜¥ç¯€', '2025-01-26': 'æ˜¥ç¯€', '2025-01-27': 'æ˜¥ç¯€', '2025-01-28': 'æ˜¥ç¯€', '2025-01-29': 'æ˜¥ç¯€', '2025-01-30': 'æ˜¥ç¯€', '2025-01-31': 'æ˜¥ç¯€', '2025-02-01': 'æ˜¥ç¯€', '2025-02-02': 'æ˜¥ç¯€', '2025-02-28': '228ç´€å¿µæ—¥', '2025-03-01': '228é€£å‡', '2025-03-02': '228é€£å‡', '2025-04-03': 'å…’ç«¥ç¯€', '2025-04-04': 'æ¸…æ˜ç¯€', '2025-04-05': 'æ¸…æ˜é€£å‡', '2025-04-06': 'æ¸…æ˜é€£å‡', '2025-05-30': 'ç«¯åˆé€£å‡', '2025-05-31': 'ç«¯åˆé€£å‡', '2025-06-01': 'ç«¯åˆç¯€', '2025-10-04': 'ä¸­ç§‹é€£å‡', '2025-10-05': 'ä¸­ç§‹é€£å‡', '2025-10-06': 'ä¸­ç§‹ç¯€', '2025-10-10': 'åœ‹æ…¶æ—¥', '2025-10-11': 'åœ‹æ…¶é€£å‡', '2025-10-12': 'åœ‹æ…¶é€£å‡',
            '2026-01-01': 'å…ƒæ—¦', '2026-02-14': 'æ˜¥ç¯€é€£å‡', '2026-02-15': 'æ˜¥ç¯€é€£å‡', '2026-02-16': 'é™¤å¤•', '2026-02-17': 'æ˜¥ç¯€', '2026-02-18': 'æ˜¥ç¯€', '2026-02-19': 'æ˜¥ç¯€', '2026-02-20': 'æ˜¥ç¯€è£œå‡', '2026-02-21': 'æ˜¥ç¯€é€£å‡', '2026-02-22': 'æ˜¥ç¯€é€£å‡', '2026-02-27': '228è£œå‡', '2026-02-28': '228ç´€å¿µæ—¥', '2026-03-01': '228é€£å‡', '2026-04-03': 'å…’ç«¥ç¯€è£œå‡', '2026-04-04': 'å…’ç«¥ç¯€', '2026-04-05': 'æ¸…æ˜ç¯€', '2026-04-06': 'æ¸…æ˜ç¯€è£œå‡', '2026-05-01': 'å‹å‹•ç¯€', '2026-05-02': 'å‹å‹•ç¯€é€£å‡', '2026-05-03': 'å‹å‹•ç¯€é€£å‡', '2026-06-19': 'ç«¯åˆç¯€', '2026-06-20': 'ç«¯åˆé€£å‡', '2026-06-21': 'ç«¯åˆé€£å‡', '2026-09-25': 'ä¸­ç§‹ç¯€', '2026-09-26': 'ä¸­ç§‹é€£å‡', '2026-09-27': 'ä¸­ç§‹é€£å‡', '2026-09-28': 'æ•™å¸«ç¯€é€£å‡', '2026-10-09': 'åœ‹æ…¶è£œå‡', '2026-10-10': 'åœ‹æ…¶æ—¥', '2026-10-11': 'åœ‹æ…¶é€£å‡', '2026-10-24': 'å…‰å¾©ç¯€é€£å‡', '2026-10-25': 'å…‰å¾©ç¯€', '2026-10-26': 'å…‰å¾©ç¯€è£œå‡', '2026-12-25': 'è¡Œæ†²ç´€å¿µæ—¥', '2026-12-26': 'é€£å‡', '2026-12-27': 'é€£å‡'
        };
        const MAKEUP_WORKDAYS = ['2025-02-08'];

        // --- è¼”åŠ©å‡½æ•¸ ---
        const splitIsoString = (isoStr) => {
            if (!isoStr) return { datePart: '', timePart: '' };
            const date = new Date(isoStr);
            const pad = (n) => n < 10 ? '0' + n : n;
            return { datePart: `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`, timePart: `${pad(date.getHours())}:${pad(date.getMinutes())}` };
        };
        const formatTime24 = (dateStr) => {
            const d = new Date(dateStr); const pad = (n) => n < 10 ? '0' + n : n; return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
        };
        const isSameDay = (d1, d2) => d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
        const isDateInRange = (checkDate, startStr, endStr) => {
            const check = new Date(checkDate); check.setHours(0,0,0,0);
            const start = new Date(startStr); start.setHours(0,0,0,0);
            const end = new Date(endStr); end.setHours(0,0,0,0);
            return check.getTime() >= start.getTime() && check.getTime() <= end.getTime();
        };
        const getDateString = (date) => { const pad = (n) => n < 10 ? '0' + n : n; return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`; };
        const isDayOff = (date) => {
            const dateStr = getDateString(date);
            if (MAKEUP_WORKDAYS.includes(dateStr)) return false;
            if (TAIWAN_HOLIDAYS[dateStr]) return TAIWAN_HOLIDAYS[dateStr];
            const day = date.getDay(); if (day === 0 || day === 6) return 'é€±æœ«'; return false;
        };

        function App() {
            const [members, setMembers] = useState([]);
            const [schedules, setSchedules] = useState([]);
            const [events, setEvents] = useState([]); 
            const [loading, setLoading] = useState(true);
            const [dbError, setDbError] = useState(null);

            const [currentView, setCurrentView] = useState('dashboard'); 
            const [viewDate, setViewDate] = useState(new Date()); 
            
            const [isManageModalOpen, setIsManageModalOpen] = useState(false);
            const [isMemberEditModalOpen, setIsMemberEditModalOpen] = useState(false);
            const [isEventModalOpen, setIsEventModalOpen] = useState(false); 
            
            const [targetMember, setTargetMember] = useState(null); 
            const [modalMode, setModalMode] = useState('list');
            
            const [statusForm, setStatusForm] = useState({ id: null, type: 'meeting', startDate: '', startTime: '08:00', endDate: '', endTime: '17:00', note: '' });
            const [memberForm, setMemberForm] = useState({ name: '', role: '', birthday: '' });
            const [eventForm, setEventForm] = useState({ id: null, title: '', type: 'client', startDate: '', endDate: '', note: '' });

            useEffect(() => {
                if (!db) { setDbError("Firebase è¨­å®šéŒ¯èª¤ã€‚"); setLoading(false); return; }
                const unsubMembers = onSnapshot(query(collection(db, "members"), orderBy("orderId")), (s) => {
                    setMembers(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false);
                });
                const unsubSchedules = onSnapshot(collection(db, "schedules"), (s) => {
                    setSchedules(s.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                const unsubEvents = onSnapshot(query(collection(db, "events")), (s) => { 
                    setEvents(s.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => { unsubMembers(); unsubSchedules(); unsubEvents(); };
            }, []);

            const initializeDb = async () => {
                if (!db) return; setLoading(true); const batch = writeBatch(db);
                for (let i = 1; i <= 12; i++) { const docRef = doc(collection(db, "members")); batch.set(docRef, { orderId: i, name: `æˆå“¡${i}`, role: i === 1 ? 'ä¸»ç®¡' : 'å°ˆå“¡' }); }
                try { await batch.commit(); alert("åˆå§‹åŒ–å®Œæˆï¼"); } catch (e) { alert("åˆå§‹åŒ–å¤±æ•—: " + e.message); } setLoading(false);
            };

            const getMemberCurrentStatus = (memberId, time) => {
                const checkTime = time.getTime();
                const currentSchedules = schedules.filter(s => s.memberId === memberId && new Date(s.start).getTime() <= checkTime && new Date(s.end).getTime() > checkTime);
                if (currentSchedules.length > 0) return { ...currentSchedules[currentSchedules.length - 1], isDefault: false };
                const holidayName = isDayOff(time); if (holidayName) return { type: 'break', note: holidayName, isDefault: true };
                const hour = time.getHours(); const isWorkTime = hour >= WORK_START_HOUR && hour < WORK_END_HOUR;
                if (isWorkTime) return { type: 'office', note: 'åœ¨ä½å­ä¸Š', isDefault: true }; return { type: 'break', note: 'éè¾¦å…¬æ™‚é–“', isDefault: true };
            };
            const getMemberDaySchedules = (memberId, date) => schedules.filter(s => s.memberId === memberId && isDateInRange(date, s.start, s.end));

            const handleEditMember = (member) => { 
                setTargetMember(member); 
                setMemberForm({ name: member.name, role: member.role, birthday: member.birthday || '' }); 
                setIsMemberEditModalOpen(true); 
            };
            const saveMemberInfo = async (e) => {
                e.preventDefault(); if (!db) return;
                try { 
                    const memberRef = doc(db, "members", targetMember.id); 
                    await updateDoc(memberRef, { name: memberForm.name, role: memberForm.role, birthday: memberForm.birthday }); 
                    setIsMemberEditModalOpen(false); 
                } catch (err) { alert("æ›´æ–°å¤±æ•—: " + err.message); }
            };

            const openManageModal = (member, mode = 'list', baseDate = viewDate) => {
                setTargetMember(member); setModalMode(mode);
                const pad = (n) => n < 10 ? '0' + n : n; const defaultDateStr = `${baseDate.getFullYear()}-${pad(baseDate.getMonth() + 1)}-${pad(baseDate.getDate())}`;
                setStatusForm({ id: null, type: 'trip', startDate: defaultDateStr, startTime: '08:00', endDate: defaultDateStr, endTime: '17:00', note: '' });
                setIsManageModalOpen(true);
            };
            const loadScheduleToForm = (schedule) => {
                const start = splitIsoString(schedule.start); const end = splitIsoString(schedule.end);
                setStatusForm({ id: schedule.id, type: schedule.type, startDate: start.datePart, startTime: start.timePart, endDate: end.datePart, endTime: end.timePart, note: schedule.note || '' });
                setModalMode('add'); 
            };
            const saveStatus = async (e) => {
                e.preventDefault(); if (!db) return;
                const startD = new Date(statusForm.startDate); const endD = new Date(statusForm.endDate);
                const startHoliday = isDayOff(startD); const endHoliday = isDayOff(endD);
                if (startHoliday) { alert(`âš ï¸ ç„¡æ³•æ’ç¨‹ï¼š${statusForm.startDate} æ˜¯ã€Œ${startHoliday}ã€ã€‚`); return; }
                if (endHoliday) { alert(`âš ï¸ ç„¡æ³•æ’ç¨‹ï¼š${statusForm.endDate} æ˜¯ã€Œ${endHoliday}ã€ã€‚`); return; }
                const startIso = `${statusForm.startDate}T${statusForm.startTime}:00`; const endIso = `${statusForm.endDate}T${statusForm.endTime}:00`;
                if (new Date(startIso) >= new Date(endIso)) { alert("âš ï¸ çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“"); return; }
                const scheduleData = { memberId: targetMember.id, type: statusForm.type, start: startIso, end: endIso, note: statusForm.note };
                try {
                    if (statusForm.id) { await updateDoc(doc(db, "schedules", statusForm.id), scheduleData); setModalMode('list'); } 
                    else { await addDoc(collection(db, "schedules"), scheduleData); alert("âœ… è¡Œç¨‹å·²åŒæ­¥ï¼"); setStatusForm(prev => ({ ...prev, note: '' })); }
                } catch (err) { alert("å„²å­˜å¤±æ•—: " + err.message); }
            };
            const deleteSchedule = async (id) => { if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { try { await deleteDoc(doc(db, "schedules", id)); if (statusForm.id === id) setModalMode('list'); } catch (err) { alert("åˆªé™¤å¤±æ•—: " + err.message); } } };

            const openEventModal = (event = null) => {
                if(event) {
                    setEventForm({
                        id: event.id, title: event.title, type: event.type, 
                        startDate: event.startDate || event.date, 
                        endDate: event.endDate || event.date, 
                        note: event.note 
                    });
                } else {
                    const today = getDateString(new Date());
                    setEventForm({ id: null, title: '', type: 'client', startDate: today, endDate: today, note: '' });
                }
                setIsEventModalOpen(true);
            };
            const saveEvent = async (e) => {
                e.preventDefault(); if(!db) return;
                if (eventForm.startDate > eventForm.endDate) { alert("âš ï¸ çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ"); return; }
                const eventData = { title: eventForm.title, type: eventForm.type, startDate: eventForm.startDate, endDate: eventForm.endDate, date: eventForm.startDate, note: eventForm.note };
                try {
                    if(eventForm.id) await updateDoc(doc(db, "events", eventForm.id), eventData);
                    else await addDoc(collection(db, "events"), eventData);
                    setIsEventModalOpen(false);
                } catch(err) { alert("å„²å­˜å¤±æ•—: "+err.message); }
            };
            const deleteEvent = async (id) => { if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ´»å‹•?")) { await deleteDoc(doc(db, "events", id)); } };

            const InfoView = () => {
                const year = viewDate.getFullYear(); const month = viewDate.getMonth() + 1;
                const monthEvents = events.filter(ev => {
                    const start = new Date(ev.startDate || ev.date); const end = new Date(ev.endDate || ev.date || ev.startDate);
                    const monthStart = new Date(year, month - 1, 1); const monthEnd = new Date(year, month, 0, 23, 59, 59);
                    return start <= monthEnd && end >= monthStart;
                }).sort((a,b) => new Date(a.startDate || a.date) - new Date(b.startDate || b.date));
                const monthBirthdays = members.filter(m => {
                    if(!m.birthday) return false; const parts = m.birthday.split(/[-/]/); if (parts.length < 2) return false; const mMonth = parts[0]; return parseInt(mMonth, 10) === month;
                });

                return (
                    <div className="flex flex-col md:flex-row gap-6 animate-in fade-in zoom-in duration-300">
                        <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                            <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-slate-800 flex items-center"><Info className="w-6 h-6 mr-2 text-indigo-500" /> {month}æœˆ é‡è¦äº‹é …</h2><button onClick={() => openEventModal()} className="flex items-center text-sm font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100 transition"><Plus className="w-4 h-4 mr-1" /> æ–°å¢äº‹é …</button></div>
                            <div className="space-y-3">{monthEvents.length === 0 ? <div className="text-center text-slate-400 py-10 border-2 border-dashed border-slate-100 rounded-xl">æœ¬æœˆå°šç„¡å®‰æ’ç‰¹åˆ¥æ´»å‹•</div> : monthEvents.map(ev => {
                                const TypeIcon = EVENT_TYPES[ev.type].icon; const startStr = ev.startDate || ev.date; const endStr = ev.endDate || ev.date; const dateDisplay = (startStr === endStr) ? startStr : `${startStr} ~ ${endStr}`; const isPast = new Date(endStr) < new Date(new Date().setHours(0,0,0,0));
                                return (<div key={ev.id} className={`flex items-start p-4 rounded-xl border ${isPast ? 'bg-slate-50 border-slate-100 opacity-60' : 'bg-white border-slate-200 shadow-sm'} group`}><div className={`p-3 rounded-full mr-4 ${EVENT_TYPES[ev.type].color}`}><TypeIcon className="w-5 h-5" /></div><div className="flex-1"><div className="flex justify-between items-start"><div><h4 className="font-bold text-slate-800 text-lg">{ev.title}</h4><span className="text-sm font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded font-mono">{dateDisplay}</span><span className="text-sm text-slate-400 ml-2">{EVENT_TYPES[ev.type].label}</span></div><div className="opacity-0 group-hover:opacity-100 flex gap-2"><button onClick={() => openEventModal(ev)} className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded"><Edit3 className="w-4 h-4" /></button><button onClick={() => deleteEvent(ev.id)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-4 h-4" /></button></div></div>{ev.note && <p className="text-slate-600 mt-2 text-sm bg-slate-50 p-2 rounded">{ev.note}</p>}</div></div>)
                            })}</div>
                        </div>
                        <div className="w-full md:w-80 bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex flex-col">
                            <h2 className="text-xl font-bold text-slate-800 flex items-center mb-6"><Cake className="w-6 h-6 mr-2 text-pink-500" /> æœ¬æœˆå£½æ˜Ÿ</h2>
                            <div className="flex-1 overflow-y-auto">{monthBirthdays.length === 0 ? <div className="text-center text-slate-400 py-10">æœ¬æœˆæ²’æœ‰å£½æ˜Ÿ</div> : <div className="grid grid-cols-2 gap-4">{monthBirthdays.map(m => (<div key={m.id} className="bg-pink-50 border border-pink-100 rounded-xl p-4 flex flex-col items-center text-center"><div className="w-12 h-12 bg-white rounded-full flex items-center justify-center text-xl font-bold text-pink-500 shadow-sm mb-2 border-2 border-pink-200">{m.name.charAt(0)}</div><div className="font-bold text-slate-700">{m.name}</div><div className="text-xs text-pink-600 font-mono mt-1 flex items-center"><PartyPopper className="w-3 h-3 mr-1" />{m.birthday}</div></div>))}</div>}</div>
                            <div className="mt-4 pt-4 border-t border-slate-100 text-xs text-slate-400 text-center">æç¤ºï¼šè«‹åœ¨ã€Œçœ‹æ¿ã€æ¨¡å¼ç·¨è¼¯æˆå“¡è³‡æ–™ä»¥è¨­å®šç”Ÿæ—¥ã€‚</div>
                        </div>
                    </div>
                );
            };

            const MiniMonthGrid = ({ member }) => {
                const year = viewDate.getFullYear(); const month = viewDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const days = Array.from({ length: daysInMonth }, (_, i) => {
                    const day = i + 1; const date = new Date(year, month, day); const isToday = isSameDay(date, new Date());
                    const daySchedules = getMemberDaySchedules(member.id, date);
                    const event = daySchedules.find(s => SPECIAL_TYPES.includes(s.type)) || daySchedules[0];
                    const holiday = isDayOff(date);
                    return { day, event, isToday, holiday };
                });
                return (
                    <div className="mt-3 pt-3 border-t border-slate-100">
                        <div className="flex justify-between items-end mb-1"><span className="text-[10px] text-slate-400 font-bold uppercase">{month + 1}æœˆ</span></div>
                        <div className="flex flex-wrap gap-0.5">
                            {days.map((d) => {
                                let bgClass = "bg-slate-200"; 
                                if (d.holiday) bgClass = "bg-red-50 opacity-40"; 
                                if (d.event) {
                                    if (d.event.type === 'trip') bgClass = "bg-purple-400 opacity-100";
                                    else if (d.event.type === 'leave') bgClass = "bg-rose-400 opacity-100";
                                    else if (d.event.type === 'meeting') bgClass = "bg-blue-400 opacity-100";
                                } else if (!d.holiday) bgClass = "bg-emerald-200"; 
                                return <div key={d.day} className={`w-2 h-2 rounded-full ${bgClass} ${d.isToday ? 'ring-1 ring-offset-1 ring-slate-400' : ''}`} title={`${d.day}æ—¥: ${d.holiday ? d.holiday : (d.event ? STATUS_TYPES[d.event.type].label : 'å‡ºå‹¤')}`}></div>;
                            })}
                        </div>
                    </div>
                );
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-100 flex-col gap-4"><div className="loading-spinner"></div><p className="text-slate-500 text-sm">æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</p></div>;
            if (dbError) return <div className="min-h-screen flex items-center justify-center bg-slate-100 p-6"><div className="bg-white p-6 rounded-2xl shadow-xl max-w-lg text-center"><AlertCircle className="w-12 h-12 text-red-500 mx-auto mb-4" /><h2 className="text-xl font-bold text-slate-800 mb-2">é€£ç·šå•é¡Œ</h2><p className="text-slate-600 mb-4">{dbError}</p></div></div>;
            if (members.length === 0) return <div className="min-h-screen flex items-center justify-center bg-slate-100"><div className="bg-white p-8 rounded-2xl shadow-xl text-center"><Cloud className="w-16 h-16 text-indigo-500 mx-auto mb-4" /><h2 className="text-2xl font-bold text-slate-800 mb-2">ç³»çµ±å°±ç·’</h2><p className="text-slate-500 mb-6">è³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œè«‹åˆå§‹åŒ–ã€‚</p><button onClick={initializeDb} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center mx-auto gap-2"><RefreshCw className="w-5 h-5" /> å»ºç«‹ 12 ä½æˆå“¡</button></div></div>;

            // çœç•¥é‡è¤‡çš„ View ç¨‹å¼ç¢¼ (DashboardView, DayView, WeekView, MonthView)ï¼Œåƒ…åœ¨æ¸²æŸ“å€åˆ‡æ›
            // ä½†ç‚ºäº†å®Œæ•´æ€§ï¼Œé€™è£¡å¿…é ˆåŒ…å«æ‰€æœ‰ View çš„å®šç¾©
            const DashboardView = () => (
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 animate-in fade-in zoom-in duration-300">
                    {members.map(member => {
                        const statusData = getMemberCurrentStatus(member.id, viewDate);
                        const config = STATUS_TYPES[statusData.type];
                        const holiday = isDayOff(viewDate);
                        const displayNote = (holiday && statusData.isDefault) ? holiday : statusData.note;
                        const displayLabel = (holiday && statusData.isDefault) ? 'æ”¾å‡' : config.label;
                        const displayIcon = (holiday && statusData.isDefault) ? Coffee : config.icon;
                        const DisplayIconComp = displayIcon;
                        return (
                            <div key={member.id} className={`bg-white rounded-2xl p-4 border shadow-sm relative group hover:shadow-md transition-all ${config.color.replace('text-', 'border-').split(' ')[2]}`}>
                                <button onClick={(e) => { e.stopPropagation(); openManageModal(member, 'add'); }} className="absolute top-2 right-2 w-8 h-8 flex items-center justify-center bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white rounded-full transition-colors z-10 shadow-sm"><Plus className="w-5 h-5" /></button>
                                <button onClick={(e) => { e.stopPropagation(); handleEditMember(member); }} className="absolute top-2 right-12 p-1.5 text-slate-300 hover:text-slate-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10"><Settings className="w-4 h-4" /></button>
                                <div onClick={() => openManageModal(member, 'list')} className="cursor-pointer">
                                    <div className="flex items-center mb-2"><div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg shadow-sm ${config.circle} border-0`}>{member.name.charAt(0)}</div><div className="ml-3"><h3 className="font-bold text-slate-800 text-base">{member.name}</h3><p className="text-xs text-slate-400">{member.role}</p></div></div>
                                    <div className={`px-3 py-1.5 rounded-lg text-sm flex items-center justify-between mb-1 ${config.color}`}><div className="flex items-center gap-2"><DisplayIconComp className="w-4 h-4" /><span className="font-bold">{displayLabel}</span></div><span className="text-[10px] font-mono opacity-70">NOW</span></div>
                                    <div className={`text-xs pl-1 h-4 truncate mb-1 ${holiday ? 'text-rose-500 font-bold' : 'text-slate-500'}`}>{displayNote}</div>
                                    <MiniMonthGrid member={member} />
                                </div>
                            </div>
                        );
                    })}
                </div>
            );

            const DayView = () => {
                const totalHours = WORK_END_HOUR + 1 - WORK_START_HOUR; 
                const daySchedules = schedules.filter(s => isDateInRange(viewDate, s.start, s.end));
                const holiday = isDayOff(viewDate);
                return (
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden animate-in slide-in-from-right duration-300">
                        <div className="flex border-b border-slate-100 bg-slate-50 justify-between items-center pr-4">
                            <div className="flex flex-1"><div className="w-20 md:w-28 flex-shrink-0 p-3 text-xs font-bold text-slate-400 border-r border-slate-100">äººå“¡</div><div className="flex-1 relative h-8">{Array.from({ length: totalHours + 1 }).map((_, i) => (<div key={i} className="absolute top-0 bottom-0 border-l border-slate-100 text-[10px] text-slate-400 pl-1 pt-2" style={{ left: `${(i / totalHours) * 100}%` }}>{WORK_START_HOUR + i}</div>))}</div></div>
                            {holiday && <div className="text-xs font-bold text-rose-500 px-3 py-1 bg-rose-50 rounded-full border border-rose-100">{holiday}</div>}
                        </div>
                        <div className="overflow-y-auto max-h-[65vh]">{members.map(member => {
                            const mySchedules = daySchedules.filter(s => s.memberId === member.id);
                            return (
                                <div key={member.id} className={`flex border-b border-slate-100 group ${holiday ? 'bg-slate-50/50' : 'hover:bg-slate-50'}`}><div className="w-20 md:w-28 flex-shrink-0 p-3 border-r border-slate-100 flex items-center justify-between"><div className="text-sm font-bold text-slate-700 truncate">{member.name}</div><button onClick={() => openManageModal(member, 'add')} className="opacity-0 group-hover:opacity-100 text-indigo-500"><Plus className="w-4 h-4" /></button></div><div className="flex-1 relative h-12">{Array.from({ length: totalHours }).map((_, i) => <div key={i} className="absolute top-0 bottom-0 border-r border-slate-50" style={{ left: `${((i + 1) / totalHours) * 100}%`, width: '1px' }}></div>)}{!holiday && <div className="absolute top-1 bottom-1 bg-emerald-50/50" style={{ left: '0%', width: `${((17-8)/totalHours)*100}%` }}></div>}{mySchedules.map(sch => {
                                    const start = new Date(sch.start); const end = new Date(sch.end); let startH = isSameDay(start, viewDate) ? start.getHours() + start.getMinutes()/60 : WORK_START_HOUR; let endH = isSameDay(end, viewDate) ? end.getHours() + end.getMinutes()/60 : WORK_END_HOUR + 1;
                                    const left = ((Math.max(startH, WORK_START_HOUR) - WORK_START_HOUR) / totalHours) * 100; const width = ((Math.min(endH, WORK_END_HOUR + 1) - Math.max(startH, WORK_START_HOUR)) / totalHours) * 100; if (width <= 0) return null;
                                    return <div key={sch.id} onClick={() => { setTargetMember(member); loadScheduleToForm(sch); setIsManageModalOpen(true); }} className={`absolute top-2 bottom-2 rounded text-[10px] flex items-center px-2 overflow-hidden cursor-pointer hover:opacity-80 border shadow-sm z-10 ${STATUS_TYPES[sch.type].color}`} style={{ left: `${left}%`, width: `${width}%` }} title={sch.note}>{sch.note || STATUS_TYPES[sch.type].label}</div>
                                })}</div></div>
                            );
                        })}</div>
                    </div>
                );
            };

            const WeekView = () => {
                const startOfWeek = new Date(viewDate); startOfWeek.setDate(viewDate.getDate() - viewDate.getDay());
                const weekDays = []; for(let i=0; i<7; i++) { const d = new Date(startOfWeek); d.setDate(startOfWeek.getDate() + i); weekDays.push(d); }
                return (
                    <div className="space-y-4 animate-in fade-in zoom-in duration-300">
                        {weekDays.map(day => {
                            const isToday = isSameDay(day, new Date()); const holiday = isDayOff(day);
                            const dayEvents = []; members.forEach(m => { const evs = getMemberDaySchedules(m.id, day); const relevant = evs.filter(e => SPECIAL_TYPES.includes(e.type)); if(relevant.length > 0) dayEvents.push({ member: m, events: relevant }); });
                            if (dayEvents.length === 0 && holiday) return null;
                            return (
                                <div key={day.toISOString()} className={`rounded-xl shadow-sm border border-slate-200 overflow-hidden ${isToday ? 'bg-indigo-50 border-indigo-200' : 'bg-white'}`}>
                                    <div className={`px-4 py-2 border-b border-slate-100 flex items-center justify-between ${isToday ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-50 text-slate-500'}`}><div className="flex items-center font-bold"><span className="mr-2 text-lg">{day.getDate()}</span><span className="text-sm">{['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][day.getDay()]}</span>{holiday && <span className="ml-2 text-xs bg-rose-100 text-rose-600 px-2 py-0.5 rounded border border-rose-200">{holiday}</span>}</div>{isToday && <span className="text-xs bg-white px-2 py-0.5 rounded-full font-bold text-indigo-600">ä»Šå¤©</span>}</div>
                                    <div className="p-2 space-y-1">{dayEvents.length === 0 ? <div className="text-center text-xs text-slate-400 py-4">{holiday ? 'æ”¾å‡' : 'æœ¬æ—¥å…¨å“¡æ­£å¸¸å‡ºå‹¤'}</div> : dayEvents.map(item => (<div key={item.member.id} onClick={() => openManageModal(item.member, 'list', day)} className="flex items-start gap-3 p-2 hover:bg-black/5 rounded-lg cursor-pointer transition-colors group"><div className="flex items-center gap-2 w-24 flex-shrink-0"><div className={`w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-bold text-slate-500`}>{item.member.name.charAt(0)}</div><span className="text-sm font-bold text-slate-700">{item.member.name}</span></div><div className="flex-1 flex flex-wrap gap-2">{item.events.map(ev => (<div key={ev.id} className={`flex items-center gap-2 px-2 py-1 rounded text-xs border ${STATUS_TYPES[ev.type].color}`}><span className="font-bold">{STATUS_TYPES[ev.type].label}</span><span className="font-mono opacity-80">{formatTime24(ev.start)}~{formatTime24(ev.end)}</span>{ev.note && <span className="text-slate-500 border-l border-slate-300 pl-2 ml-1">{ev.note}</span>}</div>))}</div><Edit3 className="w-4 h-4 text-slate-300 opacity-0 group-hover:opacity-100" /></div>))}</div>
                                </div>
                            )
                        })}
                    </div>
                );
            };

            // ğŸ”¥ ç¶œåˆæœˆæ›†è¦–åœ– (V16 Update: åœ–ä¾‹ + è‰²å½©å€éš”) ğŸ”¥
            const MonthView = () => {
                const year = viewDate.getFullYear(); const month = viewDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate(); const startDayOfWeek = new Date(year, month, 1).getDay();
                return (
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 animate-in fade-in zoom-in duration-300">
                        <div className="flex flex-col gap-4 mb-4">
                            <div className="flex items-center justify-between">
                                <h2 className="text-lg font-bold text-slate-700">{year}å¹´ {month + 1}æœˆ</h2>
                                <div className="text-xs text-slate-400 font-mono">{viewDate.toLocaleDateString()}</div>
                            </div>
                            
                            {/* ğŸ”¥ æ–°å¢ï¼šæ¸…æ¥šçš„åœ–ä¾‹èªªæ˜ ğŸ”¥ */}
                            <div className="flex flex-wrap gap-x-4 gap-y-2 bg-slate-50 p-2 rounded-lg border border-slate-100 text-xs">
                                <div className="flex items-center gap-1 font-bold text-slate-500 mr-2">äººå“¡:</div>
                                {SPECIAL_TYPES.map(type => <div key={type} className="flex items-center gap-1"><div className={`w-2 h-2 rounded-full ${STATUS_TYPES[type].circle.split(' ')[0]}`}></div><span>{STATUS_TYPES[type].label}</span></div>)}
                                <div className="w-px h-3 bg-slate-300 mx-2"></div>
                                <div className="flex items-center gap-1 font-bold text-slate-500 mr-2">äº‹é …:</div>
                                {Object.values(EVENT_TYPES).map(t => <div key={t.id} className="flex items-center gap-1"><span className={`px-1 rounded text-[9px] ${t.badge}`}>{t.char}</span><span>{t.label}</span></div>)}
                                <div className="flex items-center gap-1"><span className="px-1 rounded text-[9px] bg-pink-100 text-pink-600">å£½</span><span>ç”Ÿæ—¥</span></div>
                            </div>
                        </div>

                        <div className="grid grid-cols-7 text-center mb-2 border-b border-slate-100 pb-2 text-xs font-bold text-slate-400">{['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => <div key={d}>{d}</div>)}</div>
                        <div className="grid grid-cols-7 gap-1">{Array.from({ length: startDayOfWeek }).map((_, i) => <div key={`e-${i}`} className="min-h-[80px] bg-slate-50/30 rounded"></div>)}{Array.from({ length: daysInMonth }).map((_, i) => {
                            const date = new Date(year, month, i + 1); const isToday = isSameDay(date, new Date()); const holiday = isDayOff(date);
                            
                            // 1. æŠ“å–ç•¶å¤©æ´»å‹• (å€é–“)
                            const todaysEvents = events.filter(ev => {
                                const start = new Date(ev.startDate || ev.date); const end = new Date(ev.endDate || ev.date || ev.startDate);
                                const checkDate = new Date(date); checkDate.setHours(0,0,0,0);
                                const s = new Date(start); s.setHours(0,0,0,0);
                                const e = new Date(end); e.setHours(0,0,0,0);
                                return checkDate >= s && checkDate <= e;
                            });

                            // 2. æŠ“å–ç•¶å¤©ç”Ÿæ—¥
                            const todaysBirthdays = members.filter(m => {
                                if(!m.birthday) return false; const parts = m.birthday.split(/[-/]/); if(parts.length < 2) return false;
                                return parseInt(parts[0], 10) === (month + 1) && parseInt(parts[1], 10) === (i + 1);
                            });

                            return (
                                <div key={i} className={`min-h-[80px] border rounded p-1 flex flex-col gap-1 ${isToday ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100'} ${holiday ? 'bg-slate-50/50' : ''}`}>
                                    <div className="flex justify-between items-start">
                                        <div className="flex gap-1 flex-wrap max-w-[70%]">
                                            <span className={`text-[10px] font-bold mr-1 ${isToday ? 'text-indigo-600' : 'text-slate-400'}`}>{i + 1}</span>
                                            {/* ğŸ”¥ é¡¯ç¤ºç‰¹æ®Šå–®å­— (æ–¹å½¢æ¨™ç±¤) ğŸ”¥ */}
                                            {todaysBirthdays.length > 0 && <span className="text-[9px] bg-pink-100 text-pink-600 px-1 rounded font-bold cursor-help" title={todaysBirthdays.map(m=>m.name).join(',') + ' ç”Ÿæ—¥'}>å£½</span>}
                                            {todaysEvents.map(ev => (<span key={ev.id} className={`text-[9px] px-1 rounded font-bold cursor-help ${EVENT_TYPES[ev.type].badge}`} title={ev.title}>{EVENT_TYPES[ev.type].char}</span>))}
                                        </div>
                                        {holiday && <span className="text-[9px] text-rose-500 font-bold">{holiday}</span>}
                                    </div>
                                    <div className="flex flex-wrap gap-1 content-start">{members.map(member => {
                                        const dayEvents = getMemberDaySchedules(member.id, date); const event = dayEvents.find(s=>SPECIAL_TYPES.includes(s.type)); if (!event) return null; const config = STATUS_TYPES[event.type];
                                        // ğŸ”¥ äººå“¡ç‹€æ…‹ç¶­æŒåœ“å½¢ ğŸ”¥
                                        return <div key={member.id} onClick={(e) => { e.stopPropagation(); openManageModal(member, 'add', date); }} className={`w-5 h-5 rounded-full text-[9px] flex items-center justify-center cursor-pointer hover:scale-125 transition-transform shadow-sm text-white ${config.circle}`} title={`${member.name}: ${config.label}`}>{member.name.charAt(0)}</div>
                                    })}</div>
                                </div>
                            );
                        })}</div>
                    </div>
                );
            };

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-6 pb-20">
                    <header className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 glass-panel p-4 rounded-2xl shadow-sm border border-white sticky top-2 z-20">
                        <div className="flex items-center gap-3"><div className="bg-gradient-to-br from-indigo-500 to-purple-600 p-2.5 rounded-xl shadow-lg shadow-indigo-200 text-white"><LayoutGrid className="w-6 h-6" /></div><div><h1 className="text-xl font-bold text-slate-800 tracking-tight">éƒ¨é–€å‹•æ…‹ç®¡ç†</h1><p className="text-xs text-slate-500 font-medium">{viewDate.toLocaleDateString()} (V16 è‰²å½©å€éš”)</p></div></div>
                        <div className="flex flex-wrap items-center gap-3 justify-center"><div className="flex bg-slate-200 p-1 rounded-xl">
                            <button onClick={() => setCurrentView('dashboard')} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-all ${currentView === 'dashboard' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><LayoutGrid className="w-3.5 h-3.5" /> çœ‹æ¿</button>
                            <button onClick={() => setCurrentView('week')} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-all ${currentView === 'week' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><CalendarCheck className="w-3.5 h-3.5" /> é€±æ¸…å–®</button>
                            <button onClick={() => setCurrentView('day')} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-all ${currentView === 'day' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><List className="w-3.5 h-3.5" /> æ—¥æ›†</button>
                            <button onClick={() => setCurrentView('month')} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-all ${currentView === 'month' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><CalendarDays className="w-3.5 h-3.5" /> æœˆæ›†</button>
                            <button onClick={() => setCurrentView('info')} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-all ${currentView === 'info' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Info className="w-3.5 h-3.5" /> æœ¬æœˆäº‹é …</button>
                        </div><div className="flex items-center bg-white border border-slate-200 rounded-xl px-2 py-1 shadow-sm"><button onClick={() => setViewDate(new Date(viewDate.setDate(viewDate.getDate() - 7)))} className="p-1 hover:bg-slate-100 rounded-lg"><ChevronLeft className="w-4 h-4 text-slate-500" /></button><div className="mx-2 flex flex-col items-center w-24"><span className="text-xs font-bold text-slate-700">{viewDate.getFullYear()}-{viewDate.getMonth() + 1}-{viewDate.getDate()}</span></div><button onClick={() => setViewDate(new Date(viewDate.setDate(viewDate.getDate() + 7)))} className="p-1 hover:bg-slate-100 rounded-lg"><ChevronRight className="w-4 h-4 text-slate-500" /></button><div className="border-l border-slate-200 pl-2 ml-2"><button onClick={() => setViewDate(new Date())} className="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100">æœ¬é€±</button></div></div></div>
                    </header>
                    <main>
                        {currentView === 'dashboard' && <DashboardView />}
                        {currentView === 'week' && <WeekView />}
                        {currentView === 'day' && <DayView />}
                        {currentView === 'month' && <MonthView />}
                        {currentView === 'info' && <InfoView />}
                    </main>
                    
                    {/* è¡Œç¨‹ç®¡ç†è¦–çª— */}
                    {isManageModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4"><div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-in zoom-in duration-200 max-h-[90vh] flex flex-col"><div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 className="font-bold text-slate-800 flex items-center gap-2">{modalMode === 'add' ? <><Plus className="w-4 h-4" /> æ–°å¢è¡Œç¨‹</> : <><CalendarRange className="w-4 h-4" /> è¡Œç¨‹åˆ—è¡¨</>}<span className="text-slate-400 text-sm font-normal">| {targetMember?.name}</span></h3><button onClick={() => setIsManageModalOpen(false)}><X className="w-5 h-5 text-slate-400" /></button></div><div className="flex-1 overflow-y-auto p-4">{modalMode === 'add' && (<form onSubmit={saveStatus} className="space-y-4"><div className="bg-yellow-50 p-3 rounded-lg border border-yellow-100 flex items-start gap-2"><AlertCircle className="w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0" /><p className="text-xs text-yellow-700">é€±å…­ã€é€±æ—¥èˆ‡åœ‹å®šå‡æ—¥ç‚ºå›ºå®šä¼‘å‡æ—¥ã€‚</p></div><div className="grid grid-cols-2 gap-2">{Object.values(STATUS_TYPES).filter(t => t.id !== 'office' && t.id !== 'break').map(type => (<button key={type.id} type="button" onClick={() => setStatusForm({...statusForm, type: type.id})} className={`flex items-center p-3 rounded-xl border text-sm font-medium transition-all ${statusForm.type === type.id ? `${type.color} ring-2 ring-offset-1 ring-indigo-500` : 'border-slate-200 text-slate-600 hover:bg-slate-50'}`}><type.icon className="w-4 h-4 mr-2" />{type.label}</button>))}</div><div className="space-y-3"><div className="grid grid-cols-2 gap-3 items-end"><div><label className="text-xs font-bold text-slate-500 block mb-1">é–‹å§‹æ—¥æœŸ</label><input type="date" required className="w-full p-2 bg-slate-50 border rounded-lg text-sm font-mono" value={statusForm.startDate} onChange={e => setStatusForm({...statusForm, startDate: e.target.value})} /></div><div><label className="text-xs font-bold text-slate-500 block mb-1">æ™‚é–“</label><select value={statusForm.startTime} onChange={e => setStatusForm({...statusForm, startTime: e.target.value})} className="w-full p-2 bg-slate-50 border rounded-lg text-sm font-mono">{TIME_OPTIONS.map(t => <option key={t} value={t}>{t}</option>)}</select></div></div><div className="grid grid-cols-2 gap-3 items-end"><div><label className="text-xs font-bold text-slate-500 block mb-1">çµæŸæ—¥æœŸ</label><input type="date" required className="w-full p-2 bg-slate-50 border rounded-lg text-sm font-mono" value={statusForm.endDate} onChange={e => setStatusForm({...statusForm, endDate: e.target.value})} /></div><div><label className="text-xs font-bold text-slate-500 block mb-1">æ™‚é–“</label><select value={statusForm.endTime} onChange={e => setStatusForm({...statusForm, endTime: e.target.value})} className="w-full p-2 bg-slate-50 border rounded-lg text-sm font-mono">{TIME_OPTIONS.map(t => <option key={t} value={t}>{t}</option>)}</select></div></div></div><textarea placeholder="å‚™è¨»" className="w-full p-3 bg-slate-50 border rounded-lg text-sm h-16 resize-none" value={statusForm.note} onChange={e => setStatusForm({...statusForm, note: e.target.value})}></textarea><div className="flex gap-3 pt-2"><button type="button" onClick={() => setModalMode('list')} className="px-4 py-2 text-slate-500 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-bold">åˆ—è¡¨</button><button type="submit" className="flex-1 py-2 bg-indigo-600 text-white font-bold text-sm rounded-lg hover:bg-indigo-700 shadow-lg shadow-indigo-200 flex items-center justify-center"><Save className="w-4 h-4 mr-2" /> å„²å­˜</button></div></form>)}{modalMode === 'list' && (<div><button onClick={() => setModalMode('add')} className="w-full py-2 mb-4 border border-dashed border-indigo-300 text-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-50 flex items-center justify-center gap-2"><Plus className="w-4 h-4" /> æ–°å¢è¡Œç¨‹</button><div className="space-y-2">{schedules.filter(s => s.memberId === targetMember.id).sort((a,b) => new Date(a.start) - new Date(b.start)).map(sch => (<div key={sch.id} onClick={() => loadScheduleToForm(sch)} className="p-3 rounded-xl border border-slate-200 hover:bg-slate-50 cursor-pointer flex justify-between items-center group"><div className="flex items-center gap-3"><div className={`w-2 h-2 rounded-full ${STATUS_TYPES[sch.type].circle.split(' ')[0]}`}></div><div><div className="text-sm font-bold text-slate-700">{STATUS_TYPES[sch.type].label} <span className="text-xs font-normal text-slate-500">({sch.note})</span></div><div className="text-xs text-slate-400 font-mono">{new Date(sch.start).toLocaleDateString()} {formatTime24(sch.start)} ~ {new Date(sch.end).toLocaleDateString()} {formatTime24(sch.end)}</div></div></div><button onClick={(e) => { e.stopPropagation(); deleteSchedule(sch.id); }} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full"><Trash2 className="w-4 h-4" /></button></div>))}{schedules.filter(s => s.memberId === targetMember.id).length === 0 && <div className="text-center text-xs text-slate-400 py-4">ç„¡è¡Œç¨‹</div>}</div></div>)}</div></div></div>
                    )}
                    
                    {/* æˆå“¡ç·¨è¼¯è¦–çª— (æ–°å¢ç”Ÿæ—¥) */}
                    {isMemberEditModalOpen && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4"><div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 animate-in zoom-in duration-200"><h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2"><Edit3 className="w-5 h-5 text-indigo-600" /> ç·¨è¼¯æˆå“¡è³‡æ–™</h3><form onSubmit={saveMemberInfo} className="space-y-4"><div><label className="text-xs font-bold text-slate-500 block mb-1">å§“å</label><input type="text" required className="w-full p-2 border border-slate-300 rounded-lg" value={memberForm.name} onChange={e => setMemberForm({...memberForm, name: e.target.value})} /></div><div><label className="text-xs font-bold text-slate-500 block mb-1">è·ç¨±</label><input type="text" required className="w-full p-2 border border-slate-300 rounded-lg" value={memberForm.role} onChange={e => setMemberForm({...memberForm, role: e.target.value})} /></div><div><label className="text-xs font-bold text-slate-500 block mb-1">ç”Ÿæ—¥ (é¸å¡«, ä¾‹: 12-25)</label><input type="text" placeholder="MM-DD" className="w-full p-2 border border-slate-300 rounded-lg" value={memberForm.birthday} onChange={e => setMemberForm({...memberForm, birthday: e.target.value})} /></div><div className="flex justify-end gap-2 pt-2"><button type="button" onClick={() => setIsMemberEditModalOpen(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button><button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold shadow-md hover:bg-indigo-700">æ›´æ–°</button></div></form></div></div>)}

                    {/* ğŸ”¥ æœ¬æœˆäº‹é …ç·¨è¼¯è¦–çª— (æ”¯æ´å€é–“) ğŸ”¥ */}
                    {isEventModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4"><div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 animate-in zoom-in duration-200">
                            <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2"><Plus className="w-5 h-5 text-indigo-600" /> {eventForm.id ? 'ç·¨è¼¯äº‹é …' : 'æ–°å¢äº‹é …'}</h3>
                            <form onSubmit={saveEvent} className="space-y-4">
                                <div><label className="text-xs font-bold text-slate-500 block mb-1">é¡å‹</label><div className="grid grid-cols-2 gap-2">{Object.values(EVENT_TYPES).map(t => (<button key={t.id} type="button" onClick={() => setEventForm({...eventForm, type: t.id})} className={`flex items-center p-2 rounded-lg border text-xs font-bold transition-all ${eventForm.type === t.id ? `ring-2 ring-indigo-500 ${t.color}` : 'border-slate-200 text-slate-500'}`}><t.icon className="w-4 h-4 mr-2" />{t.label}</button>))}</div></div>
                                <div className="grid grid-cols-2 gap-2">
                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">é–‹å§‹æ—¥æœŸ</label><input type="date" required className="w-full p-2 border border-slate-300 rounded-lg" value={eventForm.startDate} onChange={e => setEventForm({...eventForm, startDate: e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">çµæŸæ—¥æœŸ</label><input type="date" required className="w-full p-2 border border-slate-300 rounded-lg" value={eventForm.endDate} onChange={e => setEventForm({...eventForm, endDate: e.target.value})} /></div>
                                </div>
                                <div><label className="text-xs font-bold text-slate-500 block mb-1">æ¨™é¡Œ</label><input type="text" required placeholder="ä¾‹: æ—¥æœ¬ç¸½éƒ¨ä¾†è¨ª" className="w-full p-2 border border-slate-300 rounded-lg" value={eventForm.title} onChange={e => setEventForm({...eventForm, title: e.target.value})} /></div>
                                <div><label className="text-xs font-bold text-slate-500 block mb-1">è©³ç´°å…§å®¹ (é¸å¡«)</label><textarea className="w-full p-2 border border-slate-300 rounded-lg h-20 resize-none" value={eventForm.note} onChange={e => setEventForm({...eventForm, note: e.target.value})}></textarea></div>
                                <div className="flex justify-end gap-2 pt-2"><button type="button" onClick={() => setIsEventModalOpen(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button><button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold shadow-md hover:bg-indigo-700">å„²å­˜</button></div>
                            </form>
                        </div></div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
